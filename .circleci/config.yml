version: 2.1
orbs:
  rn: react-native-community/react-native@6.0.1
commands:
  # https://github.com/react-native-community/react-native-circleci-orb/blob/master/src/commands/yarn_install.yml
  yarn_install:
    description: Install Javascript dependencies using Yarn. This command correctly configures the cache for any number of package.json and yarn.lock files.
    parameters:
      yarn_install_directory:
        description: Working path. Defaults to "./"
        type: string
      cache:
        description: Save and restore the build cache? Defaults to true
        type: boolean
        default: true
      cache_folder:
        description: The path to the yarn cache folder.  Defaults to /tmp/yarn
        type: string
        default: "/tmp/yarn"

    steps:
      - when:
          condition: <<parameters.cache>>
          steps:
            - run:
                name: Create cache checksum file
                command: |
                  mkdir -p ~/.tmp/checksumfiles
                  find . -type f -name 'package.json' -not -path "*node_modules*" -exec cat {} + >> ~/.tmp/checksumfiles/package.json
                  find . -type f -name 'yarn.lock' -not -path "*node_modules*" -exec cat {} + >> ~/.tmp/checksumfiles/yarn.lock
            - restore_cache:
                keys:
                  - yarn-cache-{{ arch }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}-{{ checksum "~/.tmp/checksumfiles/yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Yarn Install
          command: "yarn --cwd <<parameters.yarn_install_directory>> install --frozen-lockfile --non-interactive --cache-folder <<parameters.cache_folder>>"
      - when:
          condition: <<parameters.cache>>
          steps:
            - save_cache:
                paths:
                  - <<parameters.cache_folder>>
                key: |
                  yarn-cache-{{ arch }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}-{{ checksum "~/.tmp/checksumfiles/yarn.lock" }}-{{ .Environment.CACHE_VERSION }}

jobs:
  analyse_js:
    executor:
      name: rn/linux_js
      node_version: '12'
    steps:
      - checkout
      - yarn_install:
          yarn_install_directory: examples/purchaseTester
          cache_folder: ~/.cache/yarn
      - yarn_install:
          yarn_install_directory: examples/purchaseTesterTypescript
          cache_folder: ~/.cache/yarn
      - run:
          name: Yarn Install
          command: yarn install --non-interactive --cache-folder /tmp/yarn
      - run:
          name: Tests
          command: yarn test
      - run:
          name: Linter
          command: yarn run tslint
  android:
    executor: rn/linux_android
    steps:
      - checkout
      - yarn_install:
          yarn_install_directory: examples/purchaseTester
          cache_folder: ~/.cache/yarn
      - yarn_install:
          yarn_install_directory: examples/purchaseTesterTypescript
          cache_folder: ~/.cache/yarn
      - rn/android_build:
          project_path: examples/purchaseTesterTypescript/android
  ios:
    executor:
      name: rn/macos
      xcode_version: 12.5.0
    steps:
      - checkout
      - rn/ios_simulator_start:
          device: iPhone 11 Pro
      - yarn_install:
          yarn_install_directory: examples/purchaseTester
          cache_folder: ~/.cache/yarn
      - yarn_install:
          yarn_install_directory: examples/purchaseTesterTypescript
          cache_folder: ~/.cache/yarn
      - rn/pod_install:
          pod_install_directory: examples/purchaseTester
      - rn/pod_install:
          pod_install_directory: examples/purchaseTesterTypescript
      - rn/ios_build:
          build_configuration: Release
          device: iPhone 11 Pro
          derived_data_path: ~/DerivedData
          project_type: workspace
          project_path: examples/purchaseTesterTypescript/ios/PurchaseTester.xcworkspace
          scheme: PurchaseTester

workflows:
  test:
    jobs:
      - analyse_js
      - android
      - ios
